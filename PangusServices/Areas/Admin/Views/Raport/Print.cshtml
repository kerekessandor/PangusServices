@model IEnumerable<PangusServices.Models.Main>
<html>
<head>
    <title>Raport</title>
    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            font-size:small;
        }

        .header{
            top:0px;
            text-align:center;
            position:absolute;
            width:100%;
        }
    </style>
</head>
<body>
    @{
        IEnumerable<PangusServices.ViewModels.PaymentNumberGroup> raport = ViewBag.raporti;


        ViewBag.Title = "Raport Detailat";
        
        <h6>SC Pangus Service SRL <br />  RO 7444191 / J19/351/1995 <br /> PL. Sfantu Gheorghe <br /> Tel. 0367 409 500 / 0742 201 098 <br /> Email: pangus@rdsbv.ro</h6>

        <div class="header"><p><b style="font-size:20px">Raport detailat  @ViewBag.tim </b> <br /> @ViewBag.isUser</p></div>
        <br />
        <table style=" width:100%">
            <thead>
                <tr>
                    <th>Nr.</th>
                    <th class="col-lg-2">Nr.Inm.</th>
                    <th>Nume / Client</th>
                    <th>Prenume / Delegat</th>
                    <th>Nr.Deviz</th>
                    <th>Discount</th>
                    @foreach (var rap in raport)
                    {
                        <th class="text-center col-lg-1">
                            @rap.PaymentMethod
                        </th>
                    }

                </tr>
            </thead>
            <tbody>
                @if (Model.Count() == 0)
                {
                    <tr>
                        <td colspan="11" class="text-center">Nu sunt servicii efectuate pentru data de @DateTime.Today.ToShortDateString()</td>
                    </tr>
                }
                @{
                    var number = 0;
                }
                @foreach (var item in Model)
                {
                    number++;
                    <tr style="text-align:center">
                        <td>@number</td>
                        <td>@Html.DisplayFor(x => item.CarDetail.NrInmatricular)</td>
                        @if (item.Customer.pFizica_pJuridica == true)
                        {
                            <td style="text-align:left">@Html.DisplayFor(x => item.Customer.FirstName)</td>
                            <td style="text-align:left">@Html.DisplayFor(x => item.Customer.LastName)</td>
                        }
                        else
                        {
                            <td style="text-align:left">@Html.DisplayFor(x => item.Customer.Client)</td>
                            <td style="text-align:left">@Html.DisplayFor(x => item.Customer.Delegat)</td>
                        }
                        <td>@item.MainID</td>
                        <td class="col-lg-1">
                            @if (item.Discount == null || item.Discount == 0)
                            {
                                <b>0%</b>
                            }
                            else
                            {
                                <b>@item.Discount%</b>
                            }
                        </td>
                        @foreach (var rap in raport.ToList())
                        {
                            if (item.PaymentMethod.Name == rap.PaymentMethod)
                            {
                                <td style="text-align:center">
                                    @{
                                float osszeg = 0;
                                float price = 0;
                                float cantitate = 0;
                                foreach (var sum in item.CustomerServices)
                                {
                                    if (item.AnvelopeNoi.NoiRulate == false)
                                    {
                                        price = sum.Pret * sum.Cantitate;
                                    }
                                    else if (item.AnvelopeNoi.Cantitate >= sum.Cantitate && sum.IsEditable)
                                    {
                                        price = 0;
                                    }
                                    else if (sum.IsEditable && sum.Cantitate != null && item.AnvelopeNoi.Cantitate != null)
                                    {
                                        cantitate = sum.Cantitate - (float)item.AnvelopeNoi.Cantitate;
                                        price = sum.Pret * (float)cantitate;
                                    }
                                    else
                                    {
                                        price = sum.Pret * sum.Cantitate;
                                    }
                                    osszeg += price;
                                }
                                    }
                                    @if (item.Discount == null || item.Discount == 0)
                                    {
                                        <b>@osszeg.ToString("#,##0.00")</b>
                                    }
                                    else
                                    {
                                        osszeg = (float)(osszeg - ((item.Discount * osszeg) / 100));
                                        <b>@osszeg.ToString("#,##0.00")</b>
                                    }
                                </td>
                            }
                            else
                            {
                                <td> </td>
                            }
                        }

                    </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="6"><b class="pull-right">Total:</b></td>
                    @foreach (var item in raport)
                    {
                        float osszesen = 0;
                        float price = 0;
                        float cantitate = 0;
                        foreach (var total in Model)
                        {
                            if (total.PaymentMethod.Name == item.PaymentMethod)
                            {
                                foreach (var sum in total.CustomerServices)
                                {
                                    if (total.AnvelopeNoi.NoiRulate == false)
                                    {
                                        if (total.Discount == 0 || total.Discount == null)
                                        {
                                            price = sum.Pret * sum.Cantitate;
                                        }
                                        else
                                        {
                                            price = sum.Pret * sum.Cantitate;
                                            price = (float)(price - ((total.Discount * price) / 100));
                                        }
                                    }
                                    else if (total.AnvelopeNoi.Cantitate >= sum.Cantitate && sum.IsEditable)
                                    {
                                        price = 0;
                                    }
                                    else if (sum.IsEditable && total.AnvelopeNoi.Cantitate != null)
                                    {
                                        if (total.Discount == 0 || total.Discount == null)
                                        {
                                            cantitate = sum.Cantitate - (float)total.AnvelopeNoi.Cantitate;
                                            price = sum.Pret * (float)cantitate;
                                        }
                                        else
                                        {
                                            cantitate = sum.Cantitate - (float)total.AnvelopeNoi.Cantitate;
                                            price = sum.Pret * (float)cantitate;
                                            price = (float)(price - ((total.Discount * price) / 100));
                                        }
                                    }
                                    else
                                    {
                                        if (total.Discount == 0 || total.Discount == null)
                                        {
                                            price = sum.Pret * sum.Cantitate;
                                        }
                                        else
                                        {
                                            price = sum.Pret * sum.Cantitate;
                                            price = (float)(price - ((total.Discount * price) / 100));
                                        }
                                    }
                                    osszesen += price;
                                }

                            }
                        }
                        <td style="text-align:center">
                            <b>
                                @osszesen.ToString("#,##0.00")
                            </b>
                        </td>
                    }
                </tr>
            </tfoot>
        </table>
    }
</body>
</html>

